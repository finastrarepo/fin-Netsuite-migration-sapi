<?xml version="1.0" encoding="UTF-8"?>

<mule
	xmlns:anypoint-mq="http://www.mulesoft.org/schema/mule/anypoint-mq"
	xmlns:os="http://www.mulesoft.org/schema/mule/os"
	xmlns:wsc="http://www.mulesoft.org/schema/mule/wsc"
	xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:secure-properties="http://www.mulesoft.org/schema/mule/secure-properties"
	xmlns:api-gateway="http://www.mulesoft.org/schema/mule/api-gateway"
	xmlns:error-handler-plugin="http://www.mulesoft.org/schema/mule/error-handler-plugin"
	xmlns:apikit="http://www.mulesoft.org/schema/mule/mule-apikit"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd 
http://www.mulesoft.org/schema/mule/mule-apikit http://www.mulesoft.org/schema/mule/mule-apikit/current/mule-apikit.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/error-handler-plugin http://www.mulesoft.org/schema/mule/error-handler-plugin/current/mule-error-handler-plugin.xsd
http://www.mulesoft.org/schema/mule/api-gateway http://www.mulesoft.org/schema/mule/api-gateway/current/mule-api-gateway.xsd
http://www.mulesoft.org/schema/mule/secure-properties http://www.mulesoft.org/schema/mule/secure-properties/current/mule-secure-properties.xsd
http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd
http://www.mulesoft.org/schema/mule/wsc http://www.mulesoft.org/schema/mule/wsc/current/mule-wsc.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd
http://www.mulesoft.org/schema/mule/anypoint-mq http://www.mulesoft.org/schema/mule/anypoint-mq/current/mule-anypoint-mq.xsd">
<import doc:name="Import" doc:id="b4e62ace-fd94-4920-b442-6aee34968f03" file="common-logging-framework.xml" />
	

	<apikit:config name="fin-Netsuite-migration-sapi-config"
		api="api\fin-Netsuite-migration-sapi.raml"
		outboundHeadersMapName="outboundHeaders"
		httpStatusVarName="httpStatus" />
	<wsc:config name="Web_Service_Consumer_Config"
		doc:name="Web Service Consumer Config"
		doc:id="60f1f4f3-1f9a-4f4d-9339-02c702291b94">
		<wsc:connection soapVersion="SOAP12"
			wsdlLocation="${soap.wsdlUrl}" service="${soap.wsdlService}"
			port="${soap.wsdlPort}" address="${soap.wsdlAddress}">
			<wsc:custom-transport-configuration>
				<wsc:default-http-transport-configuration
					timeout="${soap.wsdlTimeout}" />
			</wsc:custom-transport-configuration>
		</wsc:connection>


	</wsc:config>
	<anypoint-mq:config name="Anypoint_MQ_Config" doc:name="Anypoint MQ Config" doc:id="0450c4bc-f3a7-4b9c-9bf4-3bfdb21d97ce" >
		<anypoint-mq:connection url="${secure::mq.url}" clientId="${secure::mq.clientId}" clientSecret="${secure::mq.clientSecret}" />
	</anypoint-mq:config>

	<configuration-properties
		doc:name="Configuration properties"
		doc:id="7fba4c0b-9550-44ef-9896-07959c418507"
		file="env/${anypoint_application_environment}_properties.yaml" />
	<global-property doc:name="Global Property"
		doc:id="0de248ba-a668-4048-8b7b-e0f7598b1471"
		name="anypoint_application_environment" value="dev" />
	<global-property doc:name="Global Property"
		doc:id="8611af96-b8e8-4ad3-b122-5cbd054feb99"
		name="anypoint_application_encryption_key"
		value="gqikztodczvzrqssbfhvbrupobuznuoy" />
	<secure-properties:config name="Secure_Properties_Config" doc:name="Secure Properties Config" doc:id="35abb981-8689-4ede-891c-705d445054f1" file="env/${anypoint_application_environment}_properties.yaml" key="${anypoint_application_encryption_key}" />
		
			<sub-flow name="process-error-plugin" doc:id="18b2f227-062c-47c6-bd67-8da117b3bc14" >
		<error-handler-plugin:on-error doc:name="Process Error" doc:id="0ac8a678-bb67-48f1-9cc3-7c2a3abed4e0" />
	
</sub-flow>
		<error-handler name="global-configError_Handler" doc:id="d4415fd0-638f-4047-a94c-1b4c970a44e6" >
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="8780eb1c-bf8f-4208-b8e6-0a2bf4065f84">
			<logger level="INFO" doc:name="Logger to capture error details" doc:id="b13b51da-ff88-4930-a700-f18cd5cac7ca" message="system error... will be moved to system error exchange" category="${secure::log.logError}" />
			<ee:transform doc:name="Transform Message" doc:id="e6bd59cc-2900-4191-8e5d-22c35ce2502f" >
				<ee:message >
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="errorLogData" ><![CDATA[%dw 2.0
output application/json
---
{
	errorType: 'System_Error',
	errorMessage: 'Failed due to error, sending to Exchange'
}]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<ee:transform doc:name="Transform Message" doc:id="100b8588-933b-4fc8-992b-6f6ed26d4536">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
[{
	"initialPayload": vars.logData.initialPayload,
	"payloadForTarget":  write(vars.logData.payloadForTarget) as String,
	"isSuccess":  if (error.detailedDescription != null) 0 else  1,
	"responseMsgFromTarget": if(vars.logData.responseMsgFromTarget != null) vars.logData.responseMsgFromTarget else "Error",
	"isError": if (error.detailedDescription != null) 1 else  0,
	"errorMsgFromTarget": error.detailedDescription default null, //with until sucessfull
	"txnDate": now() as String {format: "YYYYMMdd"},
	"txnDateTime":  now(),
	"externalId": vars.logData.externalId,
	"objPrefix": vars.logData.objPrefix,
	"errorType": (error.errorType.namespace ++ ":" ++ error.errorType.identifier) default 'SystemError',
	"interfaceName": vars.logData.interfaceName,
	"sourceName": vars.logData.sourceName,
	"targetName": vars.logData.targetName,
	"apiName": p('secure::api.name'),
	"apiVersion": p('secure::api.version'),
	"correlationId": vars.logData.correlationId,
	"resourcePath": vars.logData.resourcePath,
	"httpMethod": vars.logData.httpMethod
}]]]></ee:set-payload>
				</ee:message>
			</ee:transform>
			<logger level="INFO" doc:name="Logger" doc:id="873e3091-e181-47c5-a388-496964c2bd3a" message="Error details publishing to MQ"/>
			<flow-ref doc:name="process-error-plugin" doc:id="a2145400-b29c-4909-95cd-b17f1499bd0c" name="process-error-plugin"/>
		</on-error-propagate>
	</error-handler>
	
	<sub-flow name="job_rest_call_" doc:id="2bf1b774-7894-4464-b952-5826fbc0dcf3" >
              
              <logger level="INFO" doc:name="Logger" doc:id="38d88b83-e61f-42fb-9ccf-41f759bb8e0b" message="#[payload.netsuiteInternalId]"/>
		<ee:transform doc:name="restUrl" doc:id="fe59f8b6-df84-4f01-a00f-5e0da2ec12d4">
                                           <ee:message>
                                           </ee:message>
                                           <ee:variables>
                                                          <ee:set-variable variableName="restUrl"><![CDATA[%dw 2.0
output application/json

var id = payload.netsuiteInternalId

var host = p('kimbleRestNetsuite.urlHost') 
var path = p('kimbleRestNetsuite.urlPathAssignment')

---
{
url : "https://" ++ host ++ path ++ id,
method : p('http.methodGet')
  
}]]></ee:set-variable>
                                           </ee:variables>
                             </ee:transform>
                             <flow-ref doc:name="oauth-header-generator" doc:id="f99b9041-3b4d-41c6-8aa0-724a2ff69876" name="oauth-header-generator-restKimble" />
                             <logger level="INFO" doc:name="Logger" doc:id="9c48c6db-0b8c-4604-8174-20f7879d488b" message="#[vars.oAuthHeaderFinal]" category="@@@@@@@ Get call OAUTH @@@@@@@@@"/>
                             <until-successful doc:name="Until Successful" doc:id="51bb4229-dab0-4834-b7e4-272e2dc6d3bd" maxRetries="3">
			<http:request method="GET" doc:name="GetAccount" doc:id="4d985fa7-b53f-4c44-bf63-5e6adc00de35" config-ref="HTTP_Request_configuration" target="restRsp" url="#[vars.restUrl.url]" responseTimeout="${httpRequest.responseTimeout}">
                                           <http:headers><![CDATA[#[%dw 2.0
output application/java
---




{"Authorization": vars.oAuthHeaderFinal,
  "Content-Type":"application/json"
    
}]]]></http:headers>
                             </http:request>
		</until-successful>
                             <logger level="INFO" doc:name="Logger" doc:id="d692e48f-7da8-4c41-a071-87d51bd78feb" message="#[vars.restRsp]"/>
              
              
              </sub-flow>
	<sub-flow name="salesOrder_rest_call_" doc:id="18f18514-8d4b-4767-b485-b8499f089103" >
		<ee:transform doc:name="restUrl" doc:id="25516372-0c99-4016-9fed-b110dede21ff" >
			<ee:message />
			<ee:variables >
				<ee:set-variable variableName="restUrl" ><![CDATA[%dw 2.0
output application/json

var id = payload.netsuiteInternalId

var host = p('kimbleRestNetsuite.urlHost') 
var path = p('kimbleRestNetsuite.urlPathSalesOrder')

---
{
url : "https://" ++ host ++ path ++ id,
method : p('http.methodGet')
  
}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="oauth-header-generator" doc:id="c36d23a7-b34a-42ae-a2ee-f879697428ce" name="oauth-header-generator-restKimble" />
		<logger level="INFO" doc:name="Logger" doc:id="d87cc0ba-35a4-41ce-8abc-11d5f6d43fc0" message="#[vars.oAuthHeaderFinal]" category="@@@@@@@ Get call OAUTH @@@@@@@@@" />
		<until-successful maxRetries="3" doc:name="Until Successful" doc:id="f4fe9a83-7366-4a45-a7eb-06cb7279fde2"  >
			<http:request method="GET" doc:name="GetAccount" doc:id="4d985fa7-b53f-4c44-bf63-5e6adc00de35" config-ref="HTTP_Request_configuration" target="restRsp" url="#[vars.restUrl.url]" responseTimeout="${httpRequest.responseTimeout}">
                                           <http:headers><![CDATA[#[%dw 2.0
output application/java
---




{"Authorization": vars.oAuthHeaderFinal,
  "Content-Type":"application/json"
    
}]]]></http:headers>
                             </http:request>
		</until-successful>
		<logger level="INFO" doc:name="Logger" doc:id="47384371-817c-4798-bdc6-45f1c8504ad9" />
	</sub-flow>
	

	<!-- <error-handler name="global-configurationsError_Handler" doc:id="40a1db0d-6343-4029-b1aa-1b583379fce8" 
		> <on-error-propagate enableNotifications="true" logException="true" doc:name="On 
		Error Propagate" doc:id="fbe94cdf-19f3-452c-999a-d3584f4cb710" > <error-handler-plugin:on-error 
		doc:name="Process Error" doc:id="8e34c2cf-fdae-411c-8fc4-9a8f0121e0dd" notFoundError='#[if(error.muleMessage.typedValue.title 
		!= null) error.muleMessage.typedValue.title else if (error != null) error.exception.detailMessage 
		else "The API has not been implemented"]' badRequestError='#[if(error.muleMessage.typedValue.title 
		!= null) error.muleMessage.typedValue.title else if (error != null) error.exception.detailMessage 
		else "There was an issue with your request message."]' unauthorizedError='#[if(error.muleMessage.typedValue.title 
		!= null) error.muleMessage.typedValue.title else if (error != null) error.exception.detailMessage 
		else "You have issues accessing the system"]' notAcceptableError='#[if(error.muleMessage.typedValue.title 
		!= null) error.muleMessage.typedValue.title else if (error != null) error.exception.detailMessage 
		else "One of the request or parameters is unacceptable"]' timeoutError='#[if(error.muleMessage.typedValue.title 
		!= null) error.muleMessage.typedValue.title else if (error != null) error.exception.detailMessage 
		else "You request to the server has been timed-out"]' unsupportedMediaTypeError='#[if(error.muleMessage.typedValue.title 
		!= null) error.muleMessage.typedValue.title else if (error != null) error.exception.detailMessage 
		else "Media Type not supported"]' tooManyRequestsError='#[if(error.muleMessage.typedValue.title 
		!= null) error.muleMessage.typedValue.title else if (error != null) error.exception.detailMessage 
		else "You have made too many requests to the server"]' serverError='#[if(error.muleMessage.typedValue.title 
		!= null) error.muleMessage.typedValue.title else if (error != null) error.exception.detailMessage 
		else "There is a server issue"]' methodNotAllowedError='#[if(error.muleMessage.typedValue.title 
		!= null) error.muleMessage.typedValue.title else if (error != null) error.exception.detailMessage 
		else "The method has not been implemented"]' connectivityError='#[if(error.muleMessage.typedValue.title 
		!= null) error.muleMessage.typedValue.title else if (error != null) error.exception.detailMessage 
		else "You have issues accessing the system"]' correlationId="#[vars.copyCustom_corrId 
		default correlationId]"/> <set-variable value="#[attributes.httpStatus]" 
		doc:name="Set Variable" doc:id="d9b9dbbb-8e07-4d60-bef2-73dfbb08ec52" variableName="httpStatus"/> 
		</on-error-propagate> </error-handler> -->

</mule>
